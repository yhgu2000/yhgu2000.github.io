---
categories: [分享]
tags: [秘籍]
media_subpath: /assets/2023-12-05-如何重建Windows的ESP分区
---

坑死我了，这几天我的暗影精灵9掉链子了，折腾了好几天，记录一下这一波三折的经历。

## 发病

简而言之，就是高负载的情况下会掉无线网卡。高负载包括且不限于：玩游戏、编译大型应用、一次多开很多程序等。刚开始还只是偶发的，结果这几天变得越来越频繁，几乎是一有高负载网卡就会掉，就像下面这张图一样：

![](1.webp)

我实在忍不了了，于是决定花一天（事后证明是好几天）调查一下这个问题。

## 开始调查

我先是确定了一个最小的错误集：我发现不是跑所有的高负载都会出现问题，最小的错误集是只要 D 盘有高负载，网卡就会掉，比如用 AS 跑一个 5GB 的测试。

考虑到暗影精灵的网卡就在硬盘旁边，我以为可能是硬盘发热导致网卡宕机了。于是我拆开电脑，却发现 D 盘根本不在离网卡近的那个硬盘位上！从这时开始，事情就往玄学发展了。

我把两个硬盘的位置调换了一下，问题仍旧，于是我开始怀疑是软件问题。我花了点时间在移动硬盘上安装了 Win10，然后跑了几分钟的压力测试，它又没问题了……。

我以为它洗心革面了，于是我切换回了平时使用的 Win11，问题仍旧……。

## 找售后

我感觉恶心，于是去找了惠普的售后。结果到了现场以后，这家伙又不抽风了，我在人家售后门店呆了一个小时，这狗蛋什么毛病都没有，好像一个装病逃课的小孩，等到了医院真看到医生打针时又没病了！

## 搞坏 C 盘

回来之后，我还是用不安稳。我寻思该不会是驱动问题吧？于是到 HP 官网上把所有驱动下载又重装了一遍，结果还是不行。在我安装驱动的时候，有几个 BIOS 更新安装失败了，跟我报什么“磁盘空间不足”的错误，我寻思我硬盘这么大，怎么可能不够呢？应该是 ESP 分区不够吧，当时我只分了 100MB。

于是我想着把 C 盘往后空点位置，给 ESP 扩大一点，殊不知设就是糟心的开始。我从移动硬盘启动，然后用 DiskGenius 调整磁盘大小。我把 C 盘缩小了一百多 MB，本以为只变动这么点，应该很快能完成吧？结果 DiskGenius 把我 C 盘里所有文件都摸了一遍，最后还报了几个错，跟我说“分区已损坏”，我他妈瞬间就傻眼了！

我感觉这不合理，就算有几个文件出错了，也不该影响整个分区啊？于是我开始尝试进行分区表修复，我下载了傲梅分区助手。别说它还真管用：**里面有一项“检查分区表错误”的功能，运行之后它果然查出了很多错误，在修复之后，C盘又能用了！**虽然不知道会引入什么其它系统稳定性问题，但是我已经管不了那么多了。

## 搞坏 ESP 分区

我继续扩充 ESP 分区，还是用的 DiskGenius，我是真不长脑子，我以为就几百 MB，DiskGenius 总不该还出错吧？结果它又给我个惊喜：在扩充完 ESP 后，我发现 ESP 分区里的所有文件都被删除了！我*#@%+-/=~!!!!

还好我之前对 UEFI 有所了解，见到这种情况完全不慌。相比于 MBR 引导启动，UEFI 要高级很多，UEFI 启动差不多相当于在操作系统前加入了一个小操作系统，不像 MBR 直接将数据存在扇区里，这个小操作系统是用文件系统的，即 ESP 分区（FAT32格式）。引导程序和其它数据就以普通文件的方式存在这个分区里，因此方便查看和编辑。

所以，我明白只要把 Win11 的几个对应的文件复制一份过来就行了。我尝试了把 Windows 安装盘里的 `efi` 文件夹拷过来，结果开机后它显示“Your PC/Device needs to be repaired”，说是没找到对应的启动盘。因此，Windows 的 EFI 目录里的文件是会和实际硬件绑定的。

我在网上找了好久怎么重建和操作系统对应的数据，最终找到一篇[知乎博客](https://zhuanlan.zhihu.com/p/404820401?utm_id=0)。里面提到了 **Windows 自带的 `bcdboot.exe` 程序**。我把 ESP 格式化后再用它重建了 EFI 目录，果不其然就把这个问题解决了。

## 结果

重新开机进入系统后，我的心态已经发生了转变：已经服了。结果就是“没有结果”，我现在也不知道这家伙到底是什么问题！只不过从那时到现在，好像就没再发生掉网卡的问题，不过谁说得准以后会不会再出现呢？

## 总结

折腾这么几天，可以说收获了一根毛：

- ESP 分区在一开始的时候就别抠门，多分一点，给它个 512MB！
- 别用 DiskGenius 调整分区的大小！用傲梅分区助手。
- Win11 就是依托答辩。
- ESP 分区坏了不要怕，用 `bcdboost.exe` 重建它！

## 后记

在我出网卡毛病的时候，惠普的暗影精灵9正经历一次黑屏质量危机：[《惠普暗影精灵9上市仅半年遇集体投诉，消费者直指产品存在设计缺陷 —— 时代周报》](https://baijiahao.baidu.com/s?id=1784264394470769442&wfr=spider&for=pc)。果不其然，在我去惠普维修店的时候，真就遇见一位大妈拿着给儿子买的黑屏电脑过来维修……

消费者们组建了维权群，群里分享了好几个黑屏后全额退货退款成功下车的案例，好多人（包括我）看到之后心态发生了变化，反而希望电脑早点黑屏，早点退款，回来买个新的，哈哈哈😄……

不过我手上的这台到从来没有出现黑屏的问题，真不知道以后会不会出现，别给我整个保修期过了之后坏了，这就太坑了！没坏只能说没坏的话，我现在只希望它改名成“天选”，成为别人都黑它不黑的天选之子😰……
